# Detection of Malware Communication in Network Flows

**Author:** VÃ¡clav Korvas

This README.md describes instalation and usage of the main scripts in this bachelor thesis. The main scripts are: `triage_client.py`, `machine_learning.py`, `dataset_creator.py` and `capture.py`.

The script `triage_client.py` is used to automatically download malware samples from `bazaar.abuse.ch`, then analyze them using `tria.ge` and download the corresponding pcap files and reports. 

The script `machine_learning.py` is for comparing basic machine learning algorithm and how well they performe on the created dataset.

Script `dataset_creator.py` is used if you want to create your new own dataset from Suricata log files and malware samples.

And finally the script `capture.py` is used for live capture and classification of network flow records generated by Suricata deamon.

## Instalation
First you need to unzip the `xkorva03_thesis.zip` file. 
On Linux, use the command: 
```
unzip xkorva03_thesis.zip
```


Next install all the necessary python packages:
```
pip install -r requirements.txt
``` 
 After that, if you want to download malware samples just use: 
 ```
 python3 triage_client.py <arguments>
 ``` 

If you have your own account on `tria.ge` and want to use yours just change the variable **auth_api_key** in the file `triage_client.py` on line 13. You can find your authorization api key on this link: 
[https://tria.ge/account](https://tria.ge/account). Otherwise my account with my api key will be used and you wont see the submitted samples on the `tria.ge` website.

If you want to see how each machine learning algorithm performs on created dataset just run: 
```
python3 machine_learning.py
``` 
This will print on the terminal all scores like accuracy, false positivity rate, F1-score etc. 

If you want to start a live capture and classification, you need to install Suricata tool first. The guide for instalation is described here [https://suricata.readthedocs.io/en/suricata-6.0.0/install.html](https://suricata.readthedocs.io/en/suricata-6.0.0/install.html). 

Then just turn off the suricata deamon using command: 
```
sudo systemctl stop suricata.service
```

Then in config file `suricata.yaml` on line 19 you need to change the range of IP adresses you want to capture on. Default is 192.168.1.0/24.

And then launch suricata from terminal using command (with the name of the interface you want to caputre on):
```
sudo suricata -c xkorva03_thesis/suricata.yaml -i <interface name> 
```
Then just run 
```
python3 capture.py <arguments>
```

All the scripts were tested on Ubuntu 20.04 LTS and on Arch linux distribution.

## Usage of main scripts

### **triage_client.py** 

The **main command** is the `--all` command. This command downloads `n` number of samples for each family, then it will upload all the samples to the `tria.ge` for analysis. And 2 pcap files will be downloaded from 2 analysis for each malware sample. The pcaps for one malware have same name but different endings `_1` and `_2`.
And the it will download all the pcaps and overview reports as .json file. The file with malware families needs to have each family name on new line. And it's better to look the family name on the website `bazaar.abuse.ch` and use the name what they use, because sometimes it doesnt work if the name is a bit different. It the zip archive is exampe with 15 family names.

Next command is `--submit` command. This command is for uploading single file or whole directory to the `tria.ge` for analysis. If whole directory is uploaded then `csv` log files are created. But if only simple file is uploaded no log files are created.

Command `--download` is used for downloading all pcap from `.csv` log file. This command only works if some `.csv` files were created using command `--submit`.

And last command `--get` is used to download `n` number of samples of specified family.


```
Usage: python3 triage_client.py [COMMAND] [OPTIONS]

Commands:
    --help          Show this help message and exists 
    --submit	    Submit file or whole directory to tria.ge
    Options for submit:
        -d	Specifies directory with malware samples. (Can't combine with -f)
        -f	Specifies one malware sample. (Can't combine with -d)
        -o	Specifies output directory name for dowloaded pcaps

    --download	    Download all pcaps for specified csv file 
    Options for download:
        -f	Specifies one .csv file.
        -o	Specifies output directory name for dowloaded pcaps

    --get	Downloads n malware samples of specified family
    Options for get:
        -m	Specifies malware family. If the family is 2 words, than it needs to be in "" ("Smoke Loader")
        -l	Specifies how many samples of given family we want. (Maximum is 1000)
        -o	Specifies output directory name for dowloaded samples

    --all	Downloads n malware samples of specified family and runs analysis and than stores the pcap files
    Options for all:
        -m	Specifies malware family. Or .txt file with malware family names each on new line of the file
        -l	Specifies how many samples of given family we want. (Maximum is 1000)
        -o	Specifies output directory name. In this directory will be created folders malware, pcaps and reports

Report and log files are automaticaly created. The file name is based on the input directory.
COMMAND arguments can't be combined.

```
#### Examples
Here are some usage examples.
All these individual examples consist of 3 part:
* First is shown the content of the folder before the command is executed.
* Command execution and output.
* Folder content after the program was executed.
```
Download malware, then upload to tria.ge and download pcaps. Command --all.
$ ls
example_family.txt  README.md  requirements.txt  src/  triage_client.py

$ python3 triage_client.py --all -m example_family.txt -l 1 -o out

Queried 1 samples for family redlinestealer. Now the samples will be downloaded.
Downloaded malware sample: malware1.zip
Submitting files from directory: out/malware/redlinestealer
Submitted malware for analysis: malware1.zip
Queried 1 samples for family Mirai. Now the samples will be downloaded.
Downloaded malware sample: malware2.zip
Submitting files from directory: out/malware/mirai
Submitted malware for analysis: malware2.zip
Queried 1 samples for family Heodo. Now the samples will be downloaded.
Downloaded malware sample: malware3.zip
Submitting files from directory: out/malware/heodo
Submitted malware for analysis: malware3.zip
Queried 1 samples for family AgentTesla. Now the samples will be downloaded.
Downloaded malware sample: malware4.zip
Submitting files from directory: out/malware/agenttesla
Submitted malware for analysis: malware4.zip
Downloading pcap for uploaded samples...
Downloading pcap files for directory: out/malware/redlinestealer
Downloaded pcap for malware1.zip
Downloading pcap files for directory: out/malware/mirai
Downloaded pcap for malware2.zip
Downloading pcap files for directory: out/malware/heodo
Downloaded pcap for malware3.zip
Downloading pcap files for directory: out/malware/agenttesla
Downloaded pcap for malware4.zip

$ ls
example_family.txt logs/  out/  README.md   requirements.txt  src/  triage_client.py

$ ls out
malware  pcaps  reports
```
```
Download malware samples for family redlinestealer. Command --get.
$ ls 
example_family.txt  README.md  requirements.txt  src/  triage_client.py

$ python3 triage_client.py --get -m "Smoke Loader" -o malware/ -l 2

Queried 2 samples for family redlinestealer. Now the samples will be downloaded.
Downloaded malware sample: malware4.zip
Downloaded malware sample: malware5.zip

$ ls
example_family.txt logs/  malware/  README.md  requirements.txt  src/  triage_client.py
```
```
Submit directory for analysis. Command --submit 
$ ls 
example_family.txt malware/  README.md  requirements.txt  src/  triage_client.py

$ python3 triage_client.py --submit -d malware/redlinestealer/

Submitting files from directory: malware/redlinestealer/
Submitted malware: malware4.zip
Submitted malware: malware5.zip

$ ls
example_family.txt  malware/  README.md  reports/  requirements.txt  src/  triage_client.py

```

### **machine_learning.py**

Sctipt to show accuracy, F1-score, false positive rate, etc. for all 6 machine learning algorithms with normal arguments and for 4 machine learning algorithms with modified arguments.

```
Usage: python3 machine_learning.py [COMMAND]

Commands:
    --help          Show this help message and exists.
    -m              Path to the csv malware dataset file.
    -n              Path to the csv normal dataset file. 
```

#### Examples

```
$ python3 machine_learning.py -m malware_dataset.csv -n normal_dataset.csv

Model Random Forest
Accuracy: 0.9945
FPR: 0.0036
Precision: 0.9939
Sensitivity: 0.9913
F1 score: 0.9926
```

### **dataset_creator.py**

Script that serves to create dataset with flows from Suricata log file and malware report files with captured flows.

```
Usage: python3 dataset_creator.py [COMMAND]

Commands:
    --help          Show this help message and exists.
    -d              Path to the folder with all reports from malware analysis obtained with triage_client.py.
    -f              Path to log file with Suricata flow records. 
    -o              Path to output folder. Folder needs to exist.
```

#### Example

```
$ python3 dataset_creator.py -d /out/network/ -f all.json -o datasets/
```

### **capture.py**

Script that reads last record from Suricata log file and check if it contains any IOC's or if the flows in some time period were malicious and how many. It runs in infinite loop, so it can be only stopped by pressing CTRL+C twice. Twice because both threads needs to be killed.
If the capture wont work, it's maybe because you have log files somewhere else then default `/var/log/suricata/all.json`. So you need to change this to you location of log files. It's on line 21 in the file `capture.py`. 

```
Usage: python3 capture.py [COMMAND]

Commands:
    --help          Show this help message and exists.
    -d              Path to the folder with all reports containing all captured IOC's.
    -t              Time (in minutes) in which the results of classification will be printed to screen periodicaly (default is 3 minutes). 
    --verbose       To print every classified flow to terminal.
```

#### Example

```
$ python3 capture.py -d /out/reports/ --verbose -t 1
```

## Archive structure
* capture.py
* dataset_creator.py
* machine_learning.py 
* triage_client.py
* src/classifier.py
* src/csv_writer.py
* src/extractor.py
* src/flow.py
* src/flow_reader.py
* src/general.py
* src/ml_classifier.py
* src/pcap_downloader.py
* src/report.py
* src/sample_downloader.py
* src/sample_uploader.py
* src/stats.py
* src/suricata_flows.py
* example_family.txt
* README.md 
* requirements.txt
* normal_dataset.csv
* malware_dataset.csv
* suricata.yaml